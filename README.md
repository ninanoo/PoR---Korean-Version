###### ※ 이 블록체인 협의 알고리즘은 공개 알고리즘으로 아직 이론 단계입니다.<br/><br/>블록체인을 연구하고 개발하는 분들과 함께 토론하고 검증하며 알고리즘이 수정 발전되길 바랍니다.<br/><br/>아직 세 가지 임계값 산출을 위한 식이 필요합니다.<br/><br/>비선형 수치를 잘 다루시는 분들이 참여하시면 수학적으로 증명 가능한 완전한 알고리즘이 만들어지리라 생각합니다.<br/><br/>그리고 이 문서의 영문화 작업을 도와주실 분을 찾습니다.

<br/>

# PoR ( Proof of Relevancy )

관련성에 의한 증명(proof of relevancy)은 인접 블록간에 각 블록의 고유 정보로부터 구해진 관련성(relevancy)에 의해 다음 블록이 정해지는 블록체인 합의 알고리즘 입니다.
관련성은 작업증명(proof of work)의 작업이나 지분증명(proof of stake)의 지분으로부터 만들어 질 수도 있습니다.
여기서는 각 블록의 소유키를 관련성을 만드는 고유 정보의 예로 사용합니다.
비트코인(Bitcoin)과 같은 해시체인을 사용하지만 비트코인NG(Bitcoin-NG)와 같은 이중 체인 구조를 갖습니다.
이중 체인은 서로 교차하여 해시값이 연결된 키블록 체인(key block chain)과 인증블록 체인(auth block chain)으로 구성됩니다.
이중 체인과 함께 관련성, 역방향 관련성(reverse relevancy), 인증블록 생성을 위한 임계값(threshold value) 등의 특성으로 인해 원장에 대한 인증은 결정적(deterministic)으로 동작합니다.
원장에 대한 인증이 결정적으로 이루어지므로 이중지불(double spending)과 피니어택(finney attack) 등이 발생하지 않습니다.
51% 공격(51% attack)과 지역화(localization) 문제에 대해 비트코인보다 더 강한 내성을 갖습니다.
네트워크의 규모에 따라 머클트리(merkle tree)의 운용 없이 단위 원장에 대한 개별 인증 블록들을 생성할 수 있을 만큼 고속화 처리가 가능합니다.



키블록 체인에 대부분은 인증블록 생성을 마친 블록들과 인증블록을 생성하기 위한 블록으로 확정됐었으나 악의적인 목적 또는 네트워크 장애로 인해 하위 블록에 의해 제외 처리된 블록들로 구성되고 뒷부분은 인증블록 생성을 위한 후보 블록들로 구성됩니다.
후보 블록들 중 가장 먼저 생성된 후보 블록이 리더 블록이 됩니다.
모든 키블록에는 순서 번호와 관련성의 산출에 필요한 고유 정보들이 포함되고 이들을 앞 키블록의 해시값과 마지막으로 확정된 인증블록의 해시값과 조합하여 새로 만들어진 해시값이 포함됩니다.
인증블록 체인은 원장들의 인증 정보가 들어있는 블록들과 키블록 체인에서 제외된 키블록에 대한 제외 정보가 들어있는 블록들로 구성됩니다.
인증 정보가 들어있는 블록들은 인증이 확정된 블록과 확정되지 않은 블록들로 나누어집니다.
원장들의 인증 정보가 들어있는 블록에는 사용된 키블록의 순서 번호와 인증할 원장들의 인증 정보가 포함되고 이들 정보들을 앞 인증블록의 해시값과 사용된 키블록의 해시값과 조합하여 새로 만들어진 해시값이 포함됩니다.
제외 정보가 들어있는 블록에는 제외된 키블록의 순서 번호와 이를 제외 시킨 키블록의 순서 번호와 관련 제외 정보가 포함되고 이들 정보들을 앞 인증블록의 해시값, 제외된 키블록의 해시값 그리고 이를 제외 시킨 키블록의 해시값과 조합하여 새로 만들어진 해시값이 포함됩니다.
키블록 체인과 인증블록 체인의 순서 번호는 같은 순서로 쌍을 이루어 증가합니다.
인증블록 체인의 마지막 블록의 순서 번호보다 큰 순서 번호를 같는 키블록은 모두 후보 블록입니다.



새로 추가될 후보 블록들은 네크워크에서 끊임없는 확산 수렴 과정을 거치며 앞 블록과 가장 관련성이 높은 블록으로 합의가 됩니다.
어느 한 블록 자체의 관련성(self relevancy)은 앞 블록의 해시값과 해당 블록의 공개키(public key)를 첫 비트부터 비트순으로 비교하였을 때 연속해서 일치하는 비트들의 수를 통해서 생성 됩니다.
네트워크에서의 불필요한 경쟁 상황을 줄이기 위해 비트코인과 유사한 난이도(difficulty)를 갖습니다.
난이도는 일치하여야 하는 최소 비트수로 작업을 증명하기 위한 목적은 아닙니다.
단순히 공개키를 사용하는 것은 블록의 위치에 상관없이 변하지 않는 값을 사용하는 것으로 키 풀을 운용하는 방법 등으로 불필요한 자원 소모를 유발할 수 있습니다.
실제로는 앞 블록의 해시값과 해당 블록의 소유 정보를 조합하여 새로 생성된 값으로 비교합니다.
앞 블록의 해시값과 해당 블록의 공개키 등을 포함하는 해당 블록의 해시값을 구해 앞 블록의 해시값과 비교하는 방법이 있습니다.
이는 모든 블록의 해시 값의 앞 부분이 같은 값으로 유지되게 하고 서비스 별로 별도의 체인으로 운용할 때 각 체인을 구분하는 식별자로 사용될 수 있습니다.



실제 블록의 관련성은 해당 블록을 포함하면서 해당 블록의 하위 블록들에 관련성이 누적되어 정해집니다.
하위 블록들에 관련성은 체인에 추가된 순서에 따라 지수 분포로 배율이 정해집니다.
이는 상위 블록일수록 교체되는 횟수가 적어지게 만들어 체인이 결정적으로 동작하게 만듭니다.
후보 블록은 체인의 끝이 아니더라도 관련성이 기존 블록보다 더 높으면 해당 블록을 대체할 수 있고 기존 블록의 하위 블록들도 함께 버려집니다.
전체 관련성은 점점 더 높아지면서 블록의 수는 더 적어지도록 계속해서 합의가 이루어 집니다.
체인의 앞부분부터 충분한 관련성을 갖는 블록들로 채워지게 되고 실제 트랜잭션은 체인의 뒷부분의 블록들에서만 일어나게 됩니다.



아래는 어느 한 블록의 관련성을 산출하는 식입니다.

![relevancyFormula](relevancyFormula.png?raw=true "relevancyFormula")
```
r      : relevancy
c      : number of following blocks including the target block ( c > 0 )
n      : sequence number of candidate blocks starting with 0 ( n < c )
m of n : number of consecutive bits with the same value as the previous hash value starting from the beginning
a      : relevancy factor ( a > 1 )
```



첫 번째 후보 블록인 리더 블록은 다음 인증블록을 생성하기 위한 블록으로 확정되기 위해 임계값을 갖습니다.
리더 블록의 관련성이 임계값을 만족할 때까지 하위 블록들의 교체와 추가가 계속해서 이루어지며 관련성은 점점 더 높아집니다.
리더 블록의 관련성이 임계값에 다다르면 해당 블록은 인증블록의 생성을 시작하고 하위 블록의 추가는 더이상 발생하지 않으나 관련성이 더 높은 경우 교체는 계속해서 이루어집니다.
리더 블록에 의해 생성된 인증블록의 배포가 시작되면 다음 후보 블록이 리더 블록이 되고 새 리더 블록의 관련성을 기준으로 하위 블록들의 교체와 추가를 이어갑니다.



단순하게 `r/c`는 관련성 산출에 포함된 블록들의 수 대비 해당 관련성으로 관련성 효율비(relevancy efficiency ratio)입니다.
네트워크에서는 이 값이 더 높아지도록 계속해서 협의가 이루어 집니다.
이 값이 크면 각 블록들이 충분한 자체 관련성을 가지고 있는 것으로 임계값 산출을 위한 지표가 될 수도 있습니다.



매우 큰 임계값과 관련성 인자(relevancy factor) `a` 그리고 지수 감소하는 누적값의 사용 등으로 인해 어느 한 지점에서 임계값이 만족하기 위해서는 매우 많은 블록이 필요합니다.
그로 인해 키블록 체인이 네트워크에서 처음 만들어지기 시작할 때 최초의 리더 블록은 임계값을 만족하는데 충분한 시간을 가져야 합니다.
그러나 첫 블록 이후의 블록들은 리더 블록이 되었을 때 하나의 노드만 추가되어도 임계값이 만족될 수 있습니다.
리더 블록이 되는 순간 이미 임계값이 만족되었을 수 도 있습니다.
매우 많은 블록들 중에서 하나의 블록 만이 관련성 값 산출에서 제외 되었기 때문입니다.
이는 인증블록 생성의 고속화 처리가 가능하게 합니다.
머클트리를 사용할 수 도 있으나 네트워크의 규모에 따라 하나의 원장에 하나의 블록을 사용할 수 있을 정도로 성능이 나올 수 있습니다.
리더 블록들의 소모가 매우 빠를 경우 하위단에서 충분한 관련성 효율비가 유지되도록 팩터들의 값을 키워야 합니다.



악의적인 의도나 네트워크 장애로 인해 임계값을 만족한 리더 블록의 인증블록 배포가 지연되는 상황이 발생할 수 있습니다.
이를 위해 모든 키블록은 역방향 관련성을 갖습니다.
협의를 위한 관련성은 체인에서 뒤따르는 블록들의 누적값이나 역방향 관련성은 이전 블록들의 누적값으로 뒤따르는 인접한 블록에 의해 계산됩니다.
후보 블록들은 자신의 관련성을 산출하는데 사용된 `c` 값을 적용하여 이전 후보 블록들의 역방향 관련성을 산출합니다.
임계값을 만족한 블록의 바로 다음 블록은 자신의 관련성과 앞 블록의 역방향 관련성을 비교합니다.
배포된 새 인증블록을 받기 전에 자신의 관련성이 임계값을 만족하고 앞 블록의 역방향 관련성보다 자신의 정방향 관련성이 커지면 앞 블록을 제외된 블록으로 처리하고 자신이 인증블록을 생성하여 배포합니다.
제외 정보가 들어있는 블록들과 인증블록이 함께 배포가 되고 이를 받은 다른 노드들은 관련 정보를 확인한 후 수락하거나 거절합니다.
만약 두 번째 블록에서도 인증블록의 배포가 이루어지지 않으면 세 번째 블록은 첫 번째와 두 번째 블록 모두에 대해 같은 방법으로 조건이 만족 되면 자신이 인증블록을 발행합니다.
후보 블록들 중 앞부분부터 1/3에 해당하는 블록들은 모두 같은 방법으로 이전 후보 블록들을 제외시킬 수 있는 권한을 갖습니다.
이 권한을 갖는 블록들의 수는 관련성 인자 `a`에 의해 정해집니다.
전체 네트워크의 물리적 환경이나 요구되는 보안 수준에 맞게 충분히 높도록 설정해야 합니다.



역방향 관련성에 누적 계산되는 이전 블록들은 모두 네트워크에서 충분한 확산 수렴 과정을 통해 높은 자체 관련성을 가지고 있는 블록들입니다.
그러나 인증블록 배포가 지연되는 상황이 발생하면 하위 체인의 후보 블록들은 추가 없이 교체만으로 관련성을 높이므로 `c` 값은 점점 더 작아져 상대적으로 역방향 관련성은 더 낮아지게 됩니다.
이로 인해 역방향 관련성은 임계값에 다다른 리더 블록이 최대한 빠른 시간 내에 인증블록을 발행하도록 촉구합니다.
후보 블록들 중 앞부분부터 1/3에 해당하는 블록들은 모두 같은 상황에 놓이게 됩니다.



???



비트코인의 작업증명에서는 체인에 분기가 발생하는 것을 충돌 상황으로 간주하고 가장 긴 체인을 선택합니다.
관련성에 의한 증명에서는 체인에 분기가 발생하는 것을 알고리즘이 동작하는 과정으로 간주합니다.
분기가 발생한 블록의 관련성을 비교하여 더 높은 값을 같는 체인이 선택됩니다.
불필요한 작은 단위의 분기를 피하기 위해 `m` 값은 난이도보다 큰 값을 갖습니다.
협의 과정에 상당 부분을 차지할 만큼 체인에 분기는 자주 발생하나 대부분 체인의 끝 부분의 후보 블록들에서만 발생합니다.
이를 보증하기 위해 인증블록 생성을 위한 임계값을 충분히 높도록 설정합니다.
이는 체인이 운용되는 전체 네트워크의 물리적 환경과 요구되는 성능치에 의해 결정됩니다.













